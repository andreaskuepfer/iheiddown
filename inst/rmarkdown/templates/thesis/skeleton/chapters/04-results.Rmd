---
title: Results
knit: iheiddown::chapter_pdf
---

# Results {#results}

## An intro to R chunks

One of the most useful parts of _RMarkdown_ is the ability to weave or 'knit' text 
(as we've seen in the previous three chapters)
together with the code that produces tables and graphics for your final document.
This has various advantages such as:

- *coherence*: for you, having your analysis and text together means keeping a coherent story together about why you did the analysis you did, how you got to your results, and what your interpretation of these results is
- *amendability*: this gives you an opportunity to update the code, for example by filtering the data in a different way, and rerun the code to see how any statistics, tables or graphs related to the data may have changed
- *reproducibility*: this also, importantly, supports a reproducible workflow such that you, or others, can rerun and test the code at a later point

To 'knit' such text and code together, code for particular graphs or tables should first be inserted into the text in 'chunks'.
These chunks are opened with three backticks and closed in a new line with another three backticks.
The code that produces the desired output is included between these lines, 
which can include comments etc.
A key part of these chunks are the chunk parameters,
which are included in braces immediately following the first set of backticks.
The first parameter indicates the programming language.
The second parameter, 
which is optional and should be separated from the first parameter only by a space,
is a chunk label.
It is important that this chunk label includes no spaces and is unique to this chunk.
Then, separated by commas, are any additional parameters included.
In the figure below, two examples are included:
whether or not the code itself should be shown (`echo`)
and whether or not the code should be evaluated or run (`eval`).
Other parameters that we will see later include figure width, captions, etc.^[More information is available at [https://yihui.org/knitr/options/](https://yihui.org/knitr/options/).]

```{r chunk-parts, results="asis", echo=FALSE, fig.cap="Chunk parts", out.width="\\textwidth"}
knitr::include_graphics("figures/chunk-parts.png")
```

In the code chunk shown in Figure \@ref(fig:chunk-parts),
we can see that it is loading a package library.
Functions and objects loaded or created in earlier chunks are cached by default and
thus held on to for use in later chunks.
It is therefore quite common to have a chunk early on in your chapter (or even your whole dissertation)
that loads a number of the packages you need later on.
As an example, below is a short code chunk that loads a set of **R** packages that we are going to rely on
for the rest of this chapter.

```{r load_pkgs, message=FALSE}
# Load packages
library(dplyr)
library(ggplot2)
library(knitr)
```

When you click the **Knit** button above in RStudio a document will be generated that includes both content 
as well as the output of any embedded **R** code chunks within the document.
If you need a graphic or tabular material to be part of the text, you can just put it inline. 
If you need it to appear in the list of figures or tables, it should be placed in a code chunk.

In the remainder of this chapter,
we will see how to use code chunks to include figures, load and summarise data, and present results from your analysis.

## Including external figures

First, we will treat how to include figures in _RMarkdown_ in more detail.
If your thesis has a lot of figures, _RMarkdown_ might behave better for you than your usual word processor,
which can have a tendency to .
One perk is that it will automatically number the figures accordingly in each chapter.
You'll also be able to create a label for each figure, add a caption, and then reference the figure in a way similar to what we saw with tables earlier.
If you label your figures, you can move the figures around and _RMarkdown_ will automatically adjust the numbering for you.
No need for you to remember!
So that you don't have to get too far into \LaTeX\ to do this, a couple **R** functions have been created for you to assist.
You'll see their use below.

### Numbering and labelling figures

You don't need to number figures in _RMarkdown_; it'll do it automatically.
And captioning a figure is awfully easy too.
In the **R** chunk below, we will load in a picture that is stored as `iheid.eps` in our `figures` directory.
The `include_graphics()` function is from the `{knitr}` package, that does most of the heavy lifting here.
We'll label the chunk 'iheidlogo' so that we can refer back to it later,
and give the figure the caption "IHEID logo".
You will see that here you do not need to include the parameter `echo=FALSE`,
as the code including the figure is hidden by default.

```{r iheidlogo, fig.cap="IHEID logo"}
include_graphics(path = "figures/iheid.eps")
```

### Referencing figures

Referencing figures in the text should be done with a little reference to the chunk label
so that it will always refer to the right figure number, 
even if you add additional figures and plots before it.
To reference the IHEID logo use a backslash, at-symbol, and then in parentheses `fig:chunk-label`,
like so `\@ref(fig:iheidlogo)`.
Usually some descriptor like "Figure", "Fig.", "Illustration" or other is added before this reference,
so that it reads something like Figure \@ref(fig:iheidlogo).
Note that the reference is hyperlinked in the resulting PDF, 
so that you can click on it to take you to the page where the original figure is printed.

### Resizing figures

It is common to resize external image files so that they fit the format of the text.
The most common way to do this was already demonstrated in the code chunk for Figure \@ref(fig:chunk-parts) above.
There we used the parameter `out.width="\\textwidth"` to, in this case, shrink the image to the width of the text,
but this same parameter specification would also expand an image to fit the width of the text where possible.

Another option is the `out.extra` chunk option. 
This can be used to shrink or expand an image loaded from a file more specifically by specifying `"scale= "`.
Here we use the graph stored in the "subdivision.pdf" file, again found in the `figures` subdirectory.
The output can be found in Fig. \@ref(fig:subd).

```{r subd, fig.cap="Subdiv. graph", out.extra="scale=0.75"}
include_graphics("figures/subdivision.pdf")
```

We can also use the `out.extra` chunk option to enlarge figures, 
and even to rotate them any number of degrees around its axis.
In Figure \@ref(fig:subd2), we see an example where Figure \@ref(fig:subd) has been enlarged and flipped upside down.

```{r subd2, out.extra="angle=180, scale=1.1", fig.scap="Subdiv. graph flipped", fig.cap="A Larger Figure, Flipped Upside Down"}
include_graphics("figures/subdivision.pdf")
```

If you look closely at the chunk options,
you will also see that two different captions have been provided.
The `fig.scap` is a short caption that overrides the main caption, `fig.cap`, in the table of contents.
This can be very useful where, for example, you need to describe the figure in a caption over several lines,
details that do not need to be presented in the table of contents.

### Placing figures

One thing that may be annoying is the way _RMarkdown_ handles "floats" like tables and figures (it's really \LaTeX's fault). 
\LaTeX\ will try to find the best place to put your object based on the text around it and,
until you're really, truly done writing, it is best to just leave it where it lies. 
There are some optional arguments specified in the options parameter of the `label` function.
If you need to shift your figure around, it might be good to look [here](https://en.wikibooks.org/wiki/LaTeX/Floats,_Figures_and_Captions) (you can click on the word 'here') on tweaking the options argument.

Spacing out your chunks between paragraphs can help, 
as it can give \LaTeX\ more options to find a suitable home for the figure or table,
as \LaTeX\ would otherwise try and keep all the text together, saving the image for later.
A last trick is to write `\clearpage` directly in your _RMarkdown_ document.
This gives \LaTeX\ a chance to catch up with all the 'floats' it has accumulated,
and starts a new page.

\clearpage 

## Loading and exploring data

Included in this template is a file called `flights.csv`.  
This file includes a subset of the larger dataset of information about all flights that departed from Seattle and Portland in 2014. 
More information about this dataset and its **R** package is available at <https://github.com/ismayc/pnwflights14>. 
This subset includes only Portland flights and only rows that were complete with no missing values. 
Merges were also done with the `airports` and `airlines` data sets in the `pnwflights14` package to get more descriptive airport and airline names.

We can load in this data set using the following commands:

```{r load_data}
# flights.csv is in the data directory
flights <- read.csv("data/flights.csv")
```

The data is now stored in the data frame called `flights` in **R**.  
To get a better feel for the variables included in this dataset we can use a variety of functions. 
Here we can see the dimensions (rows by columns) and also the names of the columns.

```{r str}
dim(flights)
names(flights)
```

Another good idea is to take a look at the dataset in table form.  
With this dataset having more than 20,000 rows, we won't explicitly show the results of the command here. 
I recommend you enter the command into the Console **_after_** you have run the **R** chunks above to load the data into **R**.

```{r view_flights, eval=FALSE}
View(flights)
```

While not required, it is highly recommended you use the `dplyr` package to manipulate and summarize your data set as needed.  
It uses a syntax that is easy to understand using chaining operations.  
Below I've created a few examples of using `dplyr` to get information about the Portland flights in 2014.  
You will also see the use of the `ggplot2` package, which produces beautiful, high-quality academic visuals.

We begin by checking to ensure that needed packages are installed and then we load them into our current working environment:

```{r load_pkgs, message=FALSE}
# List of packages required for this analysis
pkg <- c("dplyr", "ggplot2", "knitr", "bookdown")
# Check if packages are not installed and assign the
# names of the packages not installed to the variable new.pkg
new.pkg <- pkg[!(pkg %in% installed.packages())]
# If there are any packages in the list that aren't installed,
# install them
if (length(new.pkg)) {
  install.packages(new.pkg, repos = "https://cran.rstudio.com")
}
# Load packages
library(thesisdown)
library(dplyr)
library(ggplot2)
library(knitr)
```

\clearpage

The example we show here does the following:

- Selects only the `carrier_name` and `arr_delay` from the `flights` dataset and then assigns this subset to a new variable called `flights2`. 

- Using `flights2`, we determine the largest arrival delay for each of the carriers.

```{r max_delays}
flights2 <- flights %>%
  select(carrier_name, arr_delay)
max_delays <- flights2 %>%
  group_by(carrier_name) %>%
  summarize(max_arr_delay = max(arr_delay, na.rm = TRUE))
```

A useful function in the `knitr` package for making nice tables in _R Markdown_ is called `kable`.  
It is much easier to use than manually entering values into a table by copying and pasting values into Excel or LaTeX.  
This again goes to show how nice reproducible documents can be! 
(Note the use of `results="asis"`, which will produce the table instead of the code to create the table.)  
The `caption.short` argument is used to include a shorter title to appear in the List of Tables.

```{r maxdelays, results="asis"}
kable(max_delays,
  col.names = c("Airline", "Max Arrival Delay"),
  caption = "Maximum Delays by Airline",
  caption.short = "Max Delays by Airline",
  longtable = TRUE,
  booktabs = TRUE
)
```

The last two options make the table a little easier-to-read.

We can further look into the properties of the largest value here for American Airlines Inc.  
To do so, we can isolate the row corresponding to the arrival delay of 1539 minutes for American in our original `flights` dataset.


```{r max_props}
flights %>%
  dplyr::filter(
    arr_delay == 1539,
    carrier_name == "American Airlines Inc."
  ) %>%
  select(-c(
    month, day, carrier, dest_name, hour,
    minute, carrier_name, arr_delay
  ))
```

We see that the flight occurred on March 3rd and departed a little after 2 PM on its way to Dallas/Fort Worth.  
Lastly, we show how we can visualize the arrival delay of all departing flights from Portland on March 3rd against time of departure.

```{r march3plot, fig.height=3, fig.width=6}
flights %>%
  dplyr::filter(month == 3, day == 3) %>%
  ggplot(aes(x = dep_time, y = arr_delay)) +
  geom_point()
```

## R chunks

When you click the **Knit** button above a document will be generated that includes both content as well as the output of any embedded **R** code chunks within the document. 
You can embed an **R** code chunk like this (`cars` is a built-in **R** dataset):

```{r cars}
summary(cars)
```

## Including plots

You can also embed plots. 
For example, here is a way to use the base **R** graphics package to produce a plot using the built-in `pressure` dataset:

```{r pressure, echo=FALSE, cache=TRUE, fig.height=3, fig.width=5}
plot(pressure)
```

Note that the `echo=FALSE` parameter was added to the code chunk to prevent printing of the **R** code that generated the plot. 
There are plenty of other ways to add chunk options (like `fig.height` and `fig.width` in the chunk above).  
More information is available at <https://yihui.org/knitr/options/>.  

Another useful chunk option is the setting of `cache=TRUE` as you see here.  
If document rendering becomes time consuming due to long computations or plots that are expensive to generate you can use knitr caching to improve performance.  
Later in this file, you'll see a way to reference plots created in **R** or external figures.

# Tables, Graphics, References, and Labels {#ref-labels}

## Tables

In addition to the tables that can be automatically generated from a data frame in **R** that you saw in [R Markdown Basics] using the `kable()` function, you can also create tables using _pandoc_. (More information is available at <https://pandoc.org/README.html#tables>.)  This might be useful if you don't have values specifically stored in **R**, but you'd like to display them in table form.  Below is an example.  Pay careful attention to the alignment in the table and hyphens to create the rows and columns.

----------------------------------------------------------------------------------
  Factors                    Correlation between Parents & Child      Inherited
------------------------- ----------------------------------------- --------------
  Education                                -0.49                         Yes
  
  Socio-Economic Status                     0.28                        Slight   
  
  Income                                    0.08                          No
  
  Family Size                               0.18                        Slight
  
  Occupational Prestige                     0.21                        Slight
------------------------- ----------------------------------------- --------------
Table: (\#tab:inher) Correlation of Inheritance Factors for Parents and Child 

We can also create a link to the table by doing the following: Table \@ref(tab:inher).  If you go back to [Loading and exploring data] and look at the `kable` table, we can create a reference to this max delays table too: Table \@ref(tab:maxdelays). The addition of the `(\#tab:inher)` option to the end of the table caption allows us to then make a reference to Table `\@ref(tab:label)`. Note that this reference could appear anywhere throughout the document after the table has appeared.  

<!-- We will next explore ways to create this label-ref link using figures. -->

\clearpage

<!-- clearpage ends the page, and also dumps out all floats.
  Floats are things like tables and figures. -->


## Figures

If your thesis has a lot of figures, _R Markdown_ might behave better for you than that other word processor.  One perk is that it will automatically number the figures accordingly in each chapter.    You'll also be able to create a label for each figure, add a caption, and then reference the figure in a way similar to what we saw with tables earlier.  If you label your figures, you can move the figures around and _R Markdown_ will automatically adjust the numbering for you.  No need for you to remember!  So that you don't have to get too far into LaTeX to do this, a couple **R** functions have been created for you to assist.  You'll see their use below.

<!--
One thing that may be annoying is the way _R Markdown_ handles "floats" like tables and figures (it's really \LaTeX's fault). \LaTeX\ will try to find the best place to put your object based on the text around it and until you're really, truly done writing you should just leave it where it lies. There are some optional arguments specified in the options parameter of the `label` function.  If you need to shift your figure around, it might be good to look here on tweaking the options argument:  <https://en.wikibooks.org/wiki/LaTeX/Floats,_Figures_and_Captions>

If you need a graphic or tabular material to be part of the text, you can just put it inline. If you need it to appear in the list of figures or tables, it should be placed in a code chunk.
-->


In the **R** chunk below, we will load in a picture stored as `reed.jpg` in our main directory.  We then give it the caption of "Reed logo", the label of "reedlogo", and specify that this is a figure.  Make note of the different **R** chunk options that are given in the R Markdown file (not shown in the knitted document).

```{r iheidlogo, fig.cap="IHEID logo"}
include_graphics(path = "figures/iheid.eps")
```

Here is a reference to the Reed logo: Figure \@ref(fig:iheidlogo).  Note the use of the `fig:` code here.  By naming the **R** chunk that contains the figure, we can then reference that figure later as done in the first sentence here.  We can also specify the caption for the figure via the R chunk option `fig.cap`.

\clearpage 

<!-- starts a new page and stops trying to place floats such as tables and figures -->

Below we will investigate how to save the output of an **R** plot and label it in a way similar to that done above.  Recall the `flights` dataset from Chapter \@ref(rmd-basics).  (Note that we've shown a different way to reference a section or chapter here.)  We will next explore a bar graph with the mean flight departure delays by airline from Portland for 2014.

```{r delaysboxplot, warnings=FALSE, messages=FALSE, fig.cap="Mean Delays by Airline", fig.width=6}
mean_delay_by_carrier <- flights %>%
  group_by(carrier) %>%
  summarize(mean_dep_delay = mean(dep_delay))
ggplot(mean_delay_by_carrier, aes(x = carrier, y = mean_dep_delay)) +
  geom_bar(position = "identity", stat = "identity", fill = "red")
```

Here is a reference to this image: Figure \@ref(fig:delaysboxplot).

A table linking these carrier codes to airline names is available at <https://github.com/ismayc/pnwflights14/blob/master/data/airlines.csv>.

\clearpage

Next, we will explore the use of the `out.extra` chunk option, which can be used to shrink or expand an image loaded from a file by specifying `"scale= "`. Here we use the mathematical graph stored in the "subdivision.pdf" file.

```{r subd, results="asis", echo=FALSE, fig.cap="Subdiv. graph", out.extra="scale=0.75"}
include_graphics("figures/subdivision.pdf")
```

Here is a reference to this image: Figure \@ref(fig:subd).  Note that `echo=FALSE` is specified so that the **R** code is hidden in the document.

### More Figure Stuff

Lastly, we will explore how to rotate and enlarge figures using the `out.extra` chunk option.  (Currently this only works in the PDF version of the book.)

```{r subd2, results="asis", echo=FALSE, out.extra="angle=180, scale=1.1", fig.cap="A Larger Figure, Flipped Upside Down"}
include_graphics("figures/subdivision.pdf")
```

As another example, here is a reference: Figure \@ref(fig:subd2).  

